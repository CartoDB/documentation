## Tiler

CARTO BigQuery Tiler is a solution to visualize very large spatial datasets from BigQuery.

If you have small datasets (few megabytes) on BigQuery you can use available solutions like [GeoVizQuery](https://cloud.google.com/bigquery/docs/gis-visualize) to visualize them, but if you have millions, or even billions, of rows, you need a system to load them progressively on a map. CARTO BigQuery Tiler allows you to do that without having to move your data out of BigQuery. 

CARTO BigQuery Tiler is:

* Convenient -- You can run it through our UI or directly as SQL commands in BigQuery. The data never leaves BigQuery so you don't have to worry about security and additional ETLs.
* Fast -- CARTO BigQuery Tiler benefits from the massive scalability capabilities of BigQuery and can process hundreds of millions of rows in a few minutes.
* Scalable -- This solution works for 1M points or 100B points.
* Cost-effective -- Since BigQuery separates storage from computing, the actual cost of hosting these Tilesets is very low. Additionally since you run the tiling on demand you only pay for that processing and you don't need to have a cluster available. Finally, thanks to our partitioning technology, serving tiles is very cost effective.


### Guides

#### Quickstart

There are two main procedures you can use to tilify a dataset, depending on what kind of visualization you need.

1. `tiler.CREATE_SIMPLE_TILESET`
* Use this procedure if you have a dataset with any geography type (point, line or polygon) and you want to see it at an appropriate zoom level.
* The geographies will be represented exactly as stored in BigQuery, which means that if they are too small to be visible at a certain zoom level they won't be included as part of that zoom level.
* The values associated with each feature are exactly the same as the ones available in the source dataset.

2. `tiler.CREATE_POINT_AGGREGATION_TILESET`
* Use this procedure if you have a point dataset (or something that can be converted to points) and you want to see it aggregated.
* The points will be aggregated into cells. Each feature or cell represents all the points that fall under it, so the associated properties available for visualization are generated by aggregating the values in the source dataset.
* Values of individual points are available using single_point_properties which will only be included when a cell includes only one point. Remember that you could also get similar values with the aggregated properties using functions like ANY_VALUE or FIRST_VALUE.

Let's see a couple of quick examples of how the process works.

##### US census blocks (CREATE_SIMPLE_TILESET)

In this example, we want to visualize the US block groups. As those are polygons, we don't want to aggregate them and instead we use the `CREATE_SIMPLE_TILESET` procedure. To be able to style the visualization, we want to keep two properties from the original datasource: a unique identifier (`geoid`) and the population on those blocks (`total_pop`).

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_SIMPLE_TILESET(
--SQL to use as the source (uses geom as the name for the geography)
'''
(
  SELECT
    d.geoid,
    d.total_pop,
    g.geom 
  FROM `carto-do-public-data.usa_acs.demographics_sociodemographics_usa_blockgroup_2015_5yrs_20142018` d
  JOIN `carto-do-public-data.carto.geography_usa_blockgroup_2015` g
    ON d.geoid = g.geoid
) _input
''',

-- Name and location where the Tileset will be stored.
  '`MYORGANIZATIONNAME.MYDATASETID.usa_blockgroup_population`',
  
--Options on how to generate the Tileset
  '''{
      "zoom_max": 12,
      "max_tile_size_kb": 3072,
      "properties":{
          "geoid": "String",
          "total_pop": "Number"
       }
 }''');
```

Now we can visualize it:

![Simple Tileset example](/img/bq-spatial-extension/tiler/quickstart-simpletileset.png)


##### NYC trees (CREATE_POINT_AGGREGATION_TILESET)

We are going to create a tileset for an aggregation of the trees in New York. Since we want to know how many trees are on each cell, we will add a new property to the data: `aggregated_total`. In yellow we specify the source query and in green the name of the target table that will contain the tileset.

With the query ready, you can open your BigQuery console and run it after replacing the target table name.

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_POINT_AGGREGATION_TILESET(
--SQL to use as the source (uses geom as the name for the geography)
'''(SELECT ST_GEOGPOINT(longitude, latitude) as geom, * FROM `bigquery-public-data.new_york_trees.tree_census_2015`)''',

-- Name and location where the Tileset will be stored.
-- Replace MYORGANIZATIONNAME.maps.nyc_tress_tileset with
-- YOUR destination where to store the Tileset.
  '`MYORGANIZATIONNAME.MYDATASETID.nyc_trees_tileset`',
  
--Options on how to generate the Tileset
  '''{
      "zoom_max": 14,
      "type": "quadkey",
      "resolution": 8,
      "placement": "features-centroid",
      "properties":{
        "aggregated_total": {
          "formula": "count(*)",
          "type": "Number"
        }
      },
      "single_point_properties": {
           "tree_id": "Number",
           "address": "String"
      }
 }''');
```

Now we can visualize it:

![Point Aggregation Tileset example](/img/bq-spatial-extension/tiler/quickstart-pointaggtileset.png)


#### Visualizing a tileset

### Examples

#### OSM buildings (aggregation)

We want are going to create a Point Aggregation Tileset to visualise all the features tagged as â€˜building' in the OSM BigQuery Dataset. Since this dataset has different types of geometries for the buildings, we are going to use `ST_CENTROID` to ensure they all are points.

The extra column, `aggregated_total`, is adding a count of the number of buildings that are aggregated into a cell, which in this case are quadkeys made of `z + resolution` tiles, that is, each tile will be subdivided into 4^7 (16384) cells.

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_POINT_AGGREGATION_TILESET(
  R'''(
        SELECT
            ST_CENTROID(geometry) as geom
        FROM `bigquery-public-data.geo_openstreetmap.planet_features`
        WHERE 'building' IN (SELECT key FROM UNNEST(all_tags)) AND
               geometry IS NOT NULL
    )''',
  '`your-project.your-dataset.osm_buildings_14_7`',
  R'''
    {
      "zoom_min": 0,
      "zoom_max": 14,
      "type": "quadkey",
      "resolution": 7,
      "placement": "cell-centroid",
      "properties":{
        "aggregated_total": {
          "formula":"count(*)",
          "type":"Number"
        }
      }
    }
  ''');
  ```

This process will take the over 300M buildings in the source table, aggregate them into cells and generate a table containing more than 4M tiles around the world.

#### NYC happy little trees (aggregation)

In this case we want to visualize an aggregation of the tree census of NYC. Since the table doesn't have a geography column, we are going to create it on the fly using the latitude and longitude columns.

We also want to have access to the status and health of each aggregated cell, so we add some extra properties around that. Finally, as it is a more localized dataset, we want to generate higher zoom levels (16) and when we see individual points we want access to both their official id and their address.

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_POINT_AGGREGATION_TILESET(
  R'''(
        SELECT
            ST_GEOGPOINT(longitude, latitude) as geom,
            status, health, tree_id, address
        FROM `bigquery-public-data.new_york_trees.tree_census_2015`
    )''',
  '`your-project.your-dataset.test_tilesets.nyc_trees_16_7`',
  R'''
    {
      "zoom_max": 16,
      "type": "quadkey",
      "resolution": 7,
      "placement": "features-centroid",
      "properties":{
        "aggregated_total": {
          "formula": "count(status)",
          "type": "Number"
        },
        "alive_total": {
          "formula": "countif(status = 'Alive')",
          "type": "Number"
        },
        "ok_health": {
          "formula": "countif(health = 'Good' OR health = 'Fair')",
          "type": "Number"        
        }
      },
      "single_point_properties": {
           "tree_id": "Number",
           "address": "String"
      }
    }
  ''');
```

Then we can style our visualization using the properties that we have added:

![NYC happy trees example](/img/bq-spatial-extension/tiler/examples-nychappytrees.png)

#### 2020 world population (aggregation)

For this example we are going to use a [dataset from CARTO's public Data Observatory](https://carto.com/spatial-data-catalog/browser/dataset/wp_population_172b5dfd) to visualize the 2020 world population. We are going to use the already aggregated 1km*1km grid cells:

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_POINT_AGGREGATION_TILESET(
  R'''(
        SELECT ST_Centroid(b.geom) as geom, population
        FROM
          `carto-do-public-data.worldpop.demographics_population_glo_grid1km_v1_yearly_2020` a
        INNER JOIN
          `carto-do-public-data.worldpop.geography_glo_grid1km_v1` b
        ON (a.geoid = b.geoid)
    )''',
  '`your-project.your-dataset.wpop_2020_1km_cell`',
  R'''
    {
      "zoom_max": 6,
      "type": "quadkey",
      "resolution": 7,
      "placement": "cell",
      "columns":{
        "population": {
          "formula": "sum(population)",
          "type": "Number"
        }
      }
    }
  ''');
  ```

  Note that since this dataset contains already aggregated data, it doesn't make sense to visualize it at very high zoom levels, but visualize the data at country scale.

![2020 worldpop](/img/bq-spatial-extension/tiler/examples-worldpop2020.png)


#### World's road network (lines)

We are going to use a [dataset from CARTO's public Data Observatory](https://carto.com/spatial-data-catalog/browser/geography/ne_roads_9ff89987) to visualize the world's road netowork. We are going to use the already aggregated 1km*1km grids cells:

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_SIMPLE_TILESET(
  R'''
(
  SELECT geom, type
  FROM `carto-do-public-data.natural_earth.geography_glo_roads_410`
) _input
  ''',
  R'''`cartobq.maps.natural_earth_roads`''',
  R'''
  {
      "zoom_min": 0,
      "zoom_max": 10,
      "max_tile_size_kb": 3072,
      "properties":{
          "type": "String"
       }
  }'''
);
```

The result is a worldwide map with the requested tiles, including the type of each road.

![Natural Earth Roads](/img/bq-spatial-extension/tiler/examples-naturalearthroads.png)

#### US block groups (polygons)

We are going to use a [dataset from CARTO's public Data Observatory](https://carto.com/spatial-data-catalog/browser/dataset/acs_sociodemogr_95c726f9) to visualize the block groups of the US.

```sql
--Use bqcartoeu if using the Spatial Extension in Europe's region
CALL bqcarto.tiler.CREATE_SIMPLE_TILESET(
  R'''
(
  SELECT
    d.geoid,
    d.total_pop,
    g.geom 
  FROM `carto-do-public-data.usa_acs.demographics_sociodemographics_usa_blockgroup_2015_5yrs_20142018` d
  JOIN `carto-do-public-data.carto.geography_usa_blockgroup_2015` g
    ON d.geoid = g.geoid
) _input
  ''',
  R'''`cartobq.maps.blockgroup_pop`''',
  R'''
  {
      "zoom_min": 0,
      "zoom_max": 14,
      "max_tile_size_kb": 3072,
      "properties":{
          "geoid": "String",
          "total_pop": "Number"
       }
  }'''
);
```


### CLI tool

We provide a Python Command Line tool called `carto-bq-tiler`. Think of it as a supplement to the [bq command line tool](https://cloud.google.com/bigquery/docs/bq-command-line-tool) provided by Google, but with some specific functionality to work with Tilesets. It allows you to:

* Create, list, delete, and manage Tilesets in your BigQuery project
* Visualize privately, using your authentication, your Tilesets
* Upload Tilesets generated using other tools in MBTiles format
* Download a tileset from BigQuery into a set of vector files or a MBTiles file to host your Tilesets somewhere else

##### Installation

You need to have the Google [bq command line tool](https://cloud.google.com/bigquery/docs/bq-command-line-tool) already installed and [working](https://cloud.google.com/shell/docs/using-cloud-shell). So check if this command works for you:

```python
bq query "SELECT 1"
```

If you get something like this:

![Working CLI](/img/bq-spatial-extension/tiler/working-cli.png)

you are good to go and you should install `carto-bq-tiler` like this:

```python
pip3 install carto-bq-tiler
```

Finally, to check that the tool is working just type:

```python
carto-bq-tiler --help
```

##### Authentication

`carto-bq-tiler` uses the credentials created by the [bq command line tool](https://cloud.google.com/bigquery/docs/bq-command-line-tool), and it will use the default project configured for it. If you want to use another project you can use the `-p` (`--project`) option, like for listing the tilests:

```python
carto-bq-tiler -p PROJECT list
```

Also, if you have a service account JSON file you can use it instead with `-c` (`--credentials`):

```python
carto-bq-tiler -c CREDENTIALS_JSON_PATH list
```

##### List your tilesets

List the Tilesets in your Google Cloud project with:

```python
carto-bq-tiler list
```

##### Upload a tileset

You can upload MBTiles files that contain tiles in MVT format. The only constraint is that the features must have an `id` integer property.

```python
carto-bq-tiler load MBTILES_PATH TILESET_NAME
```

`TILESET_NAME` is the tileset destination in BigQuery, and it's composed by the dataset and the table as `dataset.table`.

##### Delete a tileset

You can simply delete a dataset from BigQuery with:

```python
carto-bq-tileset remove TILESET_NAME
```

##### Export a tileset

Tilesets can be exported to your computer in two formats:

MBTiles files:

```python
carto-bq-tiler export-mbtiles TILESET_NAME
```

Directory tree:

```python
carto-bq-tiler export-tiles TILESET_NAME
```

##### View a tileset

Tilesets can be viewed and explored in multiple ways:

A downloaded directory tree:

```python
carto-bq-tiler view-local TILESET_DIRECTORY
```

A tileset in BigQuery:

```python
carto-bq-tiler view TILESET_NAME
```

A tileset in BigQuery in comparative mode:

```python
carto-bq-tiler view TILESET_NAME -c
```

An empty viewer:

```python
carto-bq-tiler view -e
```

You can also modify the port of the viewer with the `--port` option.